<!DOCTYPE html>
<html>

<head>
  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
  <script type="text/javascript">
    google.charts.load('current', { 'packages': ['corechart'] });
    google.charts.setOnLoadCallback(drawChart);

    var priceData;
    var emaData;
    var priceChart;
    var emaChart;
    var socket;

    function drawChart() {
      socket   = new WebSocket('ws://localhost:3000/price');
      socket.onopen = function (event) {
        console.log('Connected to server');
      };

      socket.onmessage = function (event) {
        var chartData = JSON.parse(event.data);

        // Convert price and ema to float numbers
        var price = parseFloat(chartData.price_data);
        var ema = parseFloat(chartData.ema);

        // ChartDataから価格、EMAとタイムスタンプ（またはTick IDなど）を取得し、グラフに追加
        addPriceData(chartData.timestamp, price);
        addEMAData(chartData.timestamp, ema);
      };


      socket.onclose = function (event) {
        console.log('Disconnected from server');
      };

      socket.onerror = function (error) {
        console.log('Error occurred:', error);
      };
      
      priceData = google.visualization.arrayToDataTable([
        ["date","price"], 
        ['0',4000000] 
      ]);

      emaData = google.visualization.arrayToDataTable([
        ["date","ema"],
        ['0',0]
      ]);

      priceChart = new google.visualization.LineChart(document.getElementById('price_chart'));
      emaChart = new google.visualization.LineChart(document.getElementById('ema_chart'));

      var options = {
        title: 'Price Data',
        curveType: 'function',
        legend: { position: 'bottom' }
      };

      priceChart.draw(priceData, options);
      priceData.removeRow(0);

      emaChart.draw(emaData, options);
      emaData.removeRow(0);
    }

    function addPriceData(tick, price) {
      var dateTick = new Date(tick);
      if (isNaN(dateTick)) { // 日付が無効な場合は処理を中断
        console.log('無効な日付です:', tick);
        return;
      }
      var formattedDate = ("00"+dateTick.getHours()).slice(-2)+":"+("00"+dateTick.getMinutes()).slice(-2)+":"+("00"+dateTick.getSeconds()).slice(-2); 
      if (priceData.getNumberOfRows() > 200) {
        priceData.removeRow(0);
      }
      console.log(formattedDate + ":" + price);
      priceData.addRow([formattedDate, price]); 
      priceChart.draw(priceData, null); // <- ここを修正
    }

    function addEMAData(tick, ema) {
      var dateTick = new Date(tick);
      if (isNaN(dateTick)) { // 日付が無効な場合は処理を中断
        console.log('無効な日付です:', tick);
        return;
      }
      var formattedDate = ("00"+dateTick.getHours()).slice(-2)+":"+("00"+dateTick.getMinutes()).slice(-2)+":"+("00"+dateTick.getSeconds()).slice(-2); 
      if (emaData.getNumberOfRows() > 200) {
        emaData.removeRow(0);
      }
      console.log(formattedDate + ":" + ema);
      emaData.addRow([formattedDate, ema]); 
      emaChart.draw(emaData, null); // <- ここを修正
    }

    window.addEventListener('beforeunload', function (event) {
      socket.close();
    });

  </script>
</head>

<body>
  <body>
    <div id="price_chart" style="width: 900px; height: 500px"></div>
    <div id="ema_chart" style="width: 900px; height: 500px"></div>
  </body>
  
</body>

</html>